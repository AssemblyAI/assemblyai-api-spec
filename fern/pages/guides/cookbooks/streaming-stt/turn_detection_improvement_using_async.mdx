---
title: "Determine Optimal Turn Detection Settings from Historical Audio Analysis"
---

This guide shows how to analyze utterance gaps from multiple pre-recorded audio files to automatically determine optimal turn detection settings for real-time streaming transcription. It processes an entire folder, aggregates gap statistics across all recordings, and configures the WebSocket with parameters tailored to your specific conversation patterns.

## Quickstart

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-1.py" />
## Step-By-Step Guide

Before we begin, make sure you have an AssemblyAI account and an API key. You can [sign up](https://assemblyai.com/dashboard/signup) and get your API key from your dashboard.

1. **Install All Required Packages**

```shell
pip install requests pyaudio websocket-client
```

2. **Configuration and Global Variables**

Set up API credentials, file paths, audio parameters (16kHz sample rate, mono channel), and initialize global variables for managing WebSocket connections and audio streaming threads.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-2.py" />
3. **Define get_audio_files() Function**

This function scans a specified folder for audio/video files with supported extensions and returns a sorted list of file paths for batch processing.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-3.py" />
4. **Define `analyze_single_file()` Function**

This function uploads an audio file to AssemblyAI, requests transcription with speaker labels enabled, polls until completion, then calculates gap statistics between utterances (average, median, min, max) and saves the transcript JSON.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-4.py" />
5. **Define `analyze_multiple_files()` Function**

This function orchestrates the analysis of all files in a folder by calling `analyze_single_file()` for each, aggregates all gap data across files, calculates overall statistics, displays per-file breakdowns, and saves a comprehensive summary JSON.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-5.py" />
6. **Define `determine_streaming_config()` Function**

This function takes aggregated gap statistics and selects one of three preset configurations with optimized turn detection parameters for different conversation styles.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-6.py" />
7. **Create WebSocket Event Handlers (`on_open`, `on_message`, `on_error`,
`on_close`)**

These functions manage the real-time streaming connection lifecycle: `on_open` starts the audio streaming thread, `on_message` processes transcription results (partial and final turns), and the close/error handlers clean up resources.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-7.py" />
8. **Define `run_streaming()` Function**

This function initializes PyAudio to capture microphone input, establishes a WebSocket connection with the optimized configuration parameters, and streams audio in real-time while displaying transcription results until the user stops with Ctrl+C.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-8.py" />
9. **Define `main()` Workflow**

Execute the three-step process: analyze all audio files in the folder, determine the best streaming configuration based on aggregated utterance gaps, then launch real-time streaming with the optimized settings.

<Code src="snippets/guides/cookbooks/streaming-stt/turn_detection_improvement_using_async/python-9.py" />
