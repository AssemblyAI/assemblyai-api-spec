This cookbook guides you through migrating from AssemblyAI's legacy Streaming STT model (v2) to our latest Universal Streaming STT model (v3), which provides ultra-low latency for faster transcription, intelligent endpointing for more natural speech detection, and improved accuracy across various audio conditions.

Check out this [blog post](https://www.assemblyai.com/blog/introducing-universal-streaming) to learn more about this new model!

## Overview of changes

The migration involves several key improvements:

- **API Version**: Upgrade from v2 (`/v2/realtime/ws`) to v3 (`/v3/ws`)
- **Enhanced Error Handling**: Robust cleanup and resource management
- **Modern Message Format**: Updated message types and structure
- **Configuration Options**: More flexible connection parameters
- **Graceful Shutdown**: Proper termination handling

You can follow the step-by-step guide below to make changes to your existing code but here is what your code should look like in the end:

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-1.js" />
For more information on our Universal Streaming feature, see [this
section](/docs/speech-to-text/universal-streaming) of our official
documentation.

## Step-by-step migration guide

### 1. Update API endpoint and configuration

**Before (v2):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-2.js" />
**After (v3):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-3.js" />
**Key Changes:**

- New base URL: `streaming.assemblyai.com` instead of `api.assemblyai.com`
- Version upgrade: `/v3/ws` instead of `/v2/realtime/ws`
- Configuration via URL parameters using `querystring`
- Added `format_turns` option for better transcript formatting

### 2. Audio configuration

**Before (v2):**

```javascript
const SAMPLE_RATE = 16000;
const CHANNELS = 1;
```

**After (v3):**

```javascript
const SAMPLE_RATE = CONNECTION_PARAMS.sample_rate;
const CHANNELS = 1;
```

**Key Changes:**

- Sample rate now references the configuration parameter

### 3. Update message handling schema

**Before (v2):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-4.js" />
**After (v3):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-5.js" />
**Key Changes:**

- Message types renamed: `SessionBegins` → `Begin`, `PartialTranscript`/`FinalTranscript` → `Turn`
- Field names updated: `message_type` → `type`, `session_id` → `id`, `text` → `transcript`
- Added session expiration timestamp handling (`expires_at`)
- New transcript formatting with `turn_is_formatted` flag
- Added turn tracking with `turn_order` and `end_of_turn` fields
- New confidence scoring with `end_of_turn_confidence`
- Added `Termination` message with session statistics
- Error handling moved from message-based to WebSocket events

### 4. Add graceful shutdown handling and improve error handling and logging

**Before (v2):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-6.js" />
**After (v3):**

<Code src="../../../../snippets/guides/cookbooks/streaming-stt/v2_to_v3_js/javascript-7.js" />
**Key Changes:**

- Proper KeyboardInterrupt handling
- Graceful termination message sending
- Detailed error context and timestamps
- Proper exception type handling
- Resource cleanup on all error paths
- Connection status checking before operations

<Warning>
  Note: Pricing is based on session duration so it is very important to close
  sessions properly to avoid unexpected usage and cost.
</Warning>

## Migration checklist

- [ ] Update API endpoint from v2 to v3
- [ ] Update message type handling (`Begin`, `Turn`, `Termination`)
- [ ] Add proper resource cleanup in all code paths
- [ ] Update field names in message parsing
- [ ] Add graceful shutdown with termination messages
- [ ] Add detailed error logging with context
- [ ] Test KeyboardInterrupt handling
- [ ] Verify audio resource cleanup
- [ ] Test connection failure scenarios

## Testing your migration

1. **Basic Functionality**: Verify transcription works with simple speech
2. **Error Handling**: Test with invalid API keys or network issues
3. **Graceful Shutdown**: Test Ctrl+C interruption
4. **Resource Cleanup**: Monitor for memory leaks during extended use
5. **Message Formatting**: Test with `format_turns` enabled/disabled

## Common migration issues

### Issue: "WebSocket connection failed"

**Solution**: Verify you're using the new v3 endpoint URL and proper authentication header format.

### Issue: "Message type not recognized"

**Solution**: Update message type handling from old names (`SessionBegins`, `PartialTranscript`) to new ones (`Begin`, `Turn`).

## Benefits of migration

- **Improved Reliability**: Better error handling and recovery
- **Lower Latency**: Reduced buffer sizes for faster response
- **Enhanced Features**: Formatted transcripts and session statistics
- **Better Resource Management**: Proper cleanup prevents memory leaks
- **Graceful Shutdown**: Clean termination with proper cleanup

## Conclusion

This migration provides a more robust, maintainable, and feature-rich streaming transcription implementation. The enhanced error handling, resource management, and modern API features make it suitable for production use cases where reliability and performance are critical.
